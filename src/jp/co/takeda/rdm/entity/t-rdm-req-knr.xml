<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="t-rdm-req-knr">

    <resultMap id="selectReqListResultMap" type="jp.co.takeda.rdm.entity.SRdmReqListEntity">
        <result column="REQ_ID" property="reqId"/>
        <result column="REQ_YMDHMS" property="reqYmdhmsFrom"/>
        <result column="REQ_CHL" property="reqChl"/>
        <result column="REQ_TYPE" property="reqType"/><!-- reqKbn=req_TYPE -->
        <result column="REQ_STS" property="reqSts"/>
        <result column="INS_NO" property="insNo"/>
        <result column="DOC_NO" property="docNo"/>
        <result column="DOC_KANJ" property="docKanj"/>
        <result column="REQ_JGI_NAME" property="reqJgiName"/>
        <result column="REQ_SHZ" property="reqShz"/>
        <result column="APR_YMDHMS" property="aPR_YMDHMS"/>
        <result column="APR_SHA_ID" property="aPR_SHA_ID"/>
        <result column="APR_MEMO" property="aPR_MEMO"/>
        <result column="APR_COMMENT" property="aprComment"/>
        <result column="INS_FORMAL_NAME" property="insFormalName"/>
        <result column="REQ_COMMENT" property="reqComment"/>
        <result column="SHN_FLG" property="shnFlg"/>
        <result column="SHN_YMDHMS" property="shnYmdhms"/>
        <result column="SHN_SHA_ID" property="shnShaId"/>
        <result column="FB_REQ_FLG" property="fbReqFlg"/>
        <result column="FB_ANS_ID" property="fbAnsId"/>
        <result column="FB_PRC_TYPE" property="fbPrcType"/>
    </resultMap>
    <resultMap id="selectCntReqListResultMap" type="jp.co.takeda.rdm.entity.join.SelectCntSelectReqListEntity">
        <result column="CNT_REQ" property="CntReq"/>
    </resultMap>
  <select id="selectReqKnr" parameterType="jp.co.takeda.rdm.entity.SRdmReqListEntity" resultMap="selectReqListResultMap">
		WITH HCP_KMS_MAX AS(--■サブクエリ（医師勤務先）
		    SELECT MAX(INS_NO) MAX_INS_NO,
		           DOC_NO
		      FROM ORAUSR01.M_RDM_HCP_WORK
		      GROUP BY DOC_NO
		)
		, HCP_INS AS (--■サブクエリ（医師勤務）
		    SELECT  HCP_REQ.REQ_ID
		           ,CASE
		                 WHEN REQ_KNR.REQ_TYPE IN ('31','34') THEN HCP_REQ.INS_NO_SK
		                 WHEN HCP_KMS_MAX.MAX_INS_NO IS NULL THEN '000000000'
		                 ELSE HCP_KMS_MAX.MAX_INS_NO
		            END HCP_INS_NO
		      FROM  ORAUSR01.T_RDM_HCP_REQ HCP_REQ
		           LEFT JOIN
		            HCP_KMS_MAX
		           ON (
		                 HCP_REQ.DOC_NO = HCP_KMS_MAX.DOC_NO
		              )
		           LEFT JOIN
		            ORAUSR01.T_RDM_REQ_KNR REQ_KNR
		           ON (
		                 REQ_KNR.REQ_ID = HCP_REQ.REQ_ID
		              )
		)
		,PREF_MST AS(  --■サブクエリ（都道府県）
    SELECT DISTINCT
          ADDR_CODE_PREF
    FROM  ORAUSR01.S_RDM_JKR_SOS_ADDR
    )

	  SELECT
		  	REQ_KNR.REQ_ID
		   ,REQ_KNR.REQ_YMDHMS
		   ,REQ_KNR.REQ_CHL
		   ,REQ_KNR.REQ_TYPE
		   ,REQ_KNR.REQ_STS,

		    --(検索処理:施設か医師かの判定:医師)
		    --HCO_REQ.INS_NO,HCO_REQ.INS_FORMAL_NAME,

		    CASE
			        WHEN REQ_KNR.REQ_TYPE IN ('01') THEN HCO_REQ.INS_NO
			        WHEN REQ_KNR.REQ_TYPE IN ('11','12','13','21','02','03','04')  THEN HCO_MST.INS_NO
			END AS INS_NO
			,CASE
			        WHEN REQ_KNR.REQ_TYPE IN ('01','04') THEN HCO_REQ.INS_FORMAL_NAME
			        WHEN REQ_KNR.REQ_TYPE IN ('11','12','13','21','02','03')   THEN HCO_MST.INS_FORMAL_NAME
			END AS INS_FORMAL_NAME

		    ,CASE
			        WHEN REQ_KNR.REQ_TYPE IN ('31') THEN HCP_REQ.DOC_NO
			        WHEN REQ_KNR.REQ_TYPE IN ('32','33','34')  THEN HCP_MST.DOC_NO
			        WHEN REQ_KNR.REQ_TYPE IN ('41','42','43','44','51')  THEN HCO_MST.INS_NO || '／' || HCP_MST.DOC_NO
			END AS DOC_NO
			,CASE
			        WHEN REQ_KNR.REQ_TYPE IN ('31') THEN HCP_REQ.DOC_KANJ
			        WHEN REQ_KNR.REQ_TYPE IN ('32','33','34')  THEN HCP_MST.DOC_KANJ
			        WHEN REQ_KNR.REQ_TYPE IN ('41','42','43','44','51')  THEN HCO_MST.INS_FORMAL_NAME || '／' || HCP_MST.DOC_KANJ
			END AS DOC_KANJ
		    ,REQ_KNR.REQ_JGI_NAME
		    ,REQ_KNR.REQ_SHZ
		    ,REQ_KNR.REQ_COMMENT
		    ,REQ_KNR.APR_YMDHMS
		    ,REQ_KNR.APR_SHA_ID
		    ,REQ_KNR.APR_MEMO
		    ,REQ_KNR.APR_COMMENT
		<if test='mrAdminFlg == "1"'>
		   ,REQ_KNR.SHN_FLG
		   ,REQ_KNR.SHN_YMDHMS
		   ,REQ_KNR.SHN_SHA_ID
		    --,REQ_KNR.FB_REQ_FLG
		    ,CODE_REQ_FLG.VALUE1_KANJ FB_REQ_FLG
		    ,REQ_KNR.FB_ANS_ID
		    --,REQ_KNR.FB_PRC_TYPE
			,CODE_PRC_TYPE.VALUE1_KANJ FB_PRC_TYPE
		</if>
	  FROM  ORAUSR01.T_RDM_REQ_KNR REQ_KNR --申請管理
			left join ORAUSR01.T_RDM_HCO_REQ HCO_REQ --施設_申請管理　
			on HCO_REQ.REQ_ID=REQ_KNR.REQ_ID
			left join ORAUSR01.T_RDM_HCO_NXT_REQ HCO_NXT_REQ --施設_来期用_申請管理
			on HCO_NXT_REQ.REQ_ID=REQ_KNR.REQ_ID
			left join ORAUSR01.T_RDM_HCO_LNK_REQ HCO_LNK_REQ --武田紐親子_来期用_申請管理
			on HCO_LNK_REQ.REQ_ID=REQ_KNR.REQ_ID
			left join ORAUSR01.T_RDM_HCO_LNK_NXT_REQ HCO_LNK_NXT_REQ --領域品目グループ別親子_申請管理
			on HCO_LNK_NXT_REQ.REQ_ID=REQ_KNR.REQ_ID
			left join ORAUSR01.T_RDM_HCP_REQ HCP_REQ --医師_申請管理
			on HCP_REQ.REQ_ID=REQ_KNR.REQ_ID
			left join ORAUSR01.T_RDM_HCP_KMU_REQ HCP_KMU_REQ --勤務先_申請管理
			on HCP_KMU_REQ.REQ_ID=REQ_KNR.REQ_ID
            LEFT JOIN HCP_INS  --■サブクエリ（医師勤務）
		    ON HCP_INS.REQ_ID=REQ_KNR.REQ_ID
			LEFT JOIN
	        ORAUSR01.M_RDM_HCO_MST HCO_MST -- 施設_基本情報
	        --ON HCP_INS.HCP_INS_NO=HCO_MST.INS_NO
            --OR HCO_REQ.INS_NO=HCO_MST.INS_NO
			--ON HCO_MST.INS_NO=nvl2(REQ_KNR.INS_NO,REQ_KNR.INS_NO,nvl2(HCO_REQ.INS_NO,HCO_REQ.INS_NO,nvl2(HCO_REQ.INS_NO,HCO_REQ.INS_NO,nvl2(HCO_NXT_REQ.INS_NO,HCO_NXT_REQ.INS_NO,nvl2(HCO_LNK_REQ.INS_NO,HCO_LNK_REQ.INS_NO,nvl2(HCO_LNK_NXT_REQ.INS_NO,HCO_LNK_NXT_REQ.INS_NO,nvl2(HCP_REQ.INS_NO_SK,HCP_REQ.INS_NO_SK,nvl2(HCP_KMU_REQ.INS_NO_SK,HCP_KMU_REQ.INS_NO_SK,HCP_KMU_REQ.INS_NO_MT))))))))
	      ON  HCP_INS.HCP_INS_NO=HCO_MST.INS_NO
              OR HCO_REQ.INS_NO=HCO_MST.INS_NO
              OR HCO_NXT_REQ.INS_NO=HCO_MST.INS_NO
              OR HCO_LNK_NXT_REQ.INS_NO=HCO_MST.INS_NO
              OR HCO_LNK_REQ.INS_NO=HCO_MST.INS_NO
            left join PREF_MST PREF_MST_A
            on PREF_MST_A.ADDR_CODE_PREF=HCO_REQ.ADDR_CODE_PREF
            left join PREF_MST PREF_MST_B
            on PREF_MST_B.ADDR_CODE_PREF=HCO_MST.ADDR_CODE_PREF
			left join ORAUSR01.M_RDM_HCP_MST HCP_MST --医師_基本情報
			on HCP_MST.DOC_NO=nvl2(REQ_KNR.DOC_NO,REQ_KNR.DOC_NO,nvl2(REQ_KNR.DOC_NO,REQ_KNR.DOC_NO,nvl2(HCP_REQ.DOC_NO,HCP_REQ.DOC_NO,HCP_KMU_REQ.DOC_NO)))
			left join  ORAUSR01.M_RDM_CODE_MST CODE_LB --コード情報 申請区分_LB
			on  CODE_LB.CODE_NAME = 'REQ_KBN_LB'
			AND CODE_LB.DEL_FLG = '0'
      		AND CODE_LB.VALUE1 = REQ_KNR.REQ_TYPE
			left join  ORAUSR01.M_RDM_CODE_MST CODE_LBV --コード情報 申請区分_LBV
			on  CODE_LBV.CODE_NAME = 'REQ_KBN_LBV'
			AND CODE_LBV.DEL_FLG = '0'
			AND CODE_LBV.VALUE2 = CODE_LB.VALUE1
			AND CODE_LBV.VALUE3 = REQ_KNR.REQ_TYPE
			<if test='mrAdminFlg == "1"'>
		    left join  ORAUSR01.M_RDM_CODE_MST CODE_REQ_FLG --コード情報FB申請要否
			ON CODE_REQ_FLG.VALUE1 = REQ_KNR.FB_REQ_FLG
		    AND CODE_REQ_FLG.CODE_NAME ='FB_REQ_FLG'
		    left join  ORAUSR01.M_RDM_CODE_MST CODE_PRC_TYPE --コード情報FB処理区分
			ON  CODE_PRC_TYPE.VALUE1 = REQ_KNR.FB_PRC_TYPE
		    AND CODE_PRC_TYPE.CODE_NAME ='FB_PRC_TYPE'
		    </if>
	WHERE
		1=1
		<if test="insNo != null">
	   		 AND HCO_MST.INS_NO = #{insNo}
	    </if>
	    <if test="reqType != null">
			<if test='reqType != "1X"'>
			    AND REQ_KNR.REQ_TYPE = #{reqType} --種別が0,施設の場合:申請区分　　--入力情報を受け取り判別
		    </if>
		    <if test='reqType == "1X"'>
			    AND REQ_KNR.REQ_TYPE IN ( '11','12','13')
			</if>
	    </if>
	    <if test="aDdrCodePref != null">
	    	<if test="reqType != null">
			    <if test='aDdrCodePref != "99"'>
				   <if test='reqType == "01"'><!-- &amp;で&になる -->
					    AND HCO_REQ.ADDR_CODE_PREF = #{aDdrCodePref}　--入力情報を受け取り判別 --//施設申請管理
				   </if>
				   <if test='reqType == "31"'><!-- &amp;で&になる -->
					    AND HCO_MST.ADDR_CODE_PREF = #{aDdrCodePref}
				   </if>
				   <if test='reqType != "01" &amp;&amp; reqType != "31"'>
						AND  HCO_MST.ADDR_CODE_PREF = #{aDdrCodePref}　　--入力情報を受け取り判別	  --//施設マスタ
			       </if>
			    </if>
			    <if test='aDdrCodePref == "99"'>
				    <if test='reqType == "01"'>
					    AND PREF_MST_A.ADDR_CODE_PREF IS NULL　--入力情報を受け取り判別 --//施設申請管理
				    </if>
				    <if test='reqType == "31" or reqType == "34"'>
					    AND PREF_MST_B.ADDR_CODE_PREF IS NULL　--入力情報を受け取り判別 --//施設申請管理
				    </if>
				    <if test='reqType == "1X"'>
				    	<!-- 旧ver
				    	AND( HCO_MST.ADDR_CODE_PREF IS NULL　　
						OR   HCO_MST.ADDR_CODE_PREF = 'Z'
						OR   HCO_MST.ADDR_CODE_PREF = '00'
						OR   HCO_MST.ADDR_CODE_PREF = '51'
		                )
				    	 -->
						AND( PREF_MST_A.ADDR_CODE_PREF IS NULL　　--入力情報を受け取り判別	  --//施設マスタ
						AND   PREF_MST_B.ADDR_CODE_PREF IS NULL
		                )
				    </if>
				    <if test='reqType == "21"'>
				    	<!-- 旧ver
				    	AND( HCO_MST.ADDR_CODE_PREF IS NULL　　
						OR   HCO_MST.ADDR_CODE_PREF = 'Z'
						OR   HCO_MST.ADDR_CODE_PREF = '00'
						OR   HCO_MST.ADDR_CODE_PREF = '51'
		                )
				    	 -->
						AND( PREF_MST_A.ADDR_CODE_PREF IS NULL　　--入力情報を受け取り判別	  --//施設マスタ
						AND   PREF_MST_B.ADDR_CODE_PREF IS NULL
		                )
				    </if>
				    <if test='reqType != "01" &amp;&amp; reqType != "31" &amp;&amp; reqType != "1X" &amp;&amp; reqType != "21"'>
						AND PREF_MST_B.ADDR_CODE_PREF IS NULL　　--入力情報を受け取り判別	  --//施設マスタ
				    </if>
				</if>
			</if>
			<if test="reqType == null">
			   	<if test='aDdrCodePref != "99"'>
					    AND(HCO_REQ.ADDR_CODE_PREF = #{aDdrCodePref}　--入力情報を受け取り判別 --//01 24しかなかったので24で行きます
						OR  HCO_MST.ADDR_CODE_PREF = #{aDdrCodePref}　　--入力情報を受け取り判別
					    )
			    </if>
			    <if test='aDdrCodePref == "99"'>
				    	<!-- 旧ver
				    	AND( HCO_MST.ADDR_CODE_PREF IS NULL　　
						OR   HCO_MST.ADDR_CODE_PREF = 'Z'
						OR   HCO_MST.ADDR_CODE_PREF = '00'
						OR   HCO_MST.ADDR_CODE_PREF = '51'
		                )
				    	 -->
						AND( PREF_MST_A.ADDR_CODE_PREF IS NULL　　--入力情報を受け取り判別	  --//施設マスタ
						AND   PREF_MST_B.ADDR_CODE_PREF IS NULL
		                )
			    </if>
			</if>
	    </if>
	    <!-- MRのみ　申請者従業員番号 -->
	    <if test="jgiNo != null">
	    	<if test='mrAdminFlg == "0"'>
				AND REQ_KNR.REQ_JGI_NO = #{jgiNo}
			</if>
	    </if><!-- MR -->
	    <!-- 管理者のみ -->
	    <if test='mrAdminFlg == "1"'>
	    <if test="brCode != null">
	    	AND REQ_KNR.REQ_BR_CODE = #{brCode} --管理者権限の場合　医薬支店C(本来の数字は入力される？)	    </if>
	    <if test="distCode != null">
			AND REQ_KNR.REQ_DIST_CODE = #{distCode} --管理者権限の場合　医薬営業所C(本来の数字は入力される？)		</if>
	    <if test="reqJgiName != null">
	    	AND REQ_KNR.REQ_JGI_NAME LIKE  '%' || #{reqJgiName} || '%'
	    </if>
	   	<!-- 管理者 -->
		</if>
	    <if test=" insKanjiSrch != null">
		    AND(HCO_REQ.INS_ABBR_NAME LIKE  '%' || #{insKanjiSrch} || '%'
			OR  HCO_REQ.INS_FORMAL_NAME LIKE'%' || #{insKanjiSrch} || '%'
			OR  HCO_REQ.INS_CONT_NAME LIKE  '%' || #{insKanjiSrch} || '%'
			OR  HCO_MST.INS_KANJ_SRCH LIKE  '%' || #{insKanjiSrch} || '%'
		    )
	    </if>
	    <if test="insNo != null">
	    AND HCO_MST.INS_NO = #{insNo}
	    AND
			(  HCO_REQ.INS_NO = #{insNo} --種別が0,施設の場合:施設固定コード(本来の数字は入力情報から取得する)
			OR HCO_NXT_REQ.INS_NO = #{insNo}
			OR HCO_LNK_REQ.INS_NO = #{insNo}
			OR HCO_LNK_NXT_REQ.INS_NO = #{insNo}
			OR HCP_REQ.INS_NO_SK = #{insNo}
			OR HCP_KMU_REQ.INS_NO_SK = #{insNo}
			OR HCP_KMU_REQ.INS_NO_MT = #{insNo}
			)
		</if>

		<if test="insClass != null">
			AND(HCO_REQ.INS_CLASS = #{insClass} --種別が0,施設の場合:施設_申請管理：施設分類　　--入力情報を受け取り判別
			OR  HCO_MST.INS_CLASS = #{insClass}　--種別が0,施設の場合:施設_基本情報：施設分類　　--入力情報を受け取り判別
			)
		</if>
		<if test="insSbt != null">
			AND(HCO_REQ.INS_SBT = #{insSbt}    --種別が0,施設の場合 ：施設種別　　　--入力情報を受け取り判別
			OR  HCO_MST.INS_SBT = #{insSbt}    --入力情報を受け取り判別：施設種別　
			)
		</if>
		<if test="hoInsType != null">
			AND(HCO_REQ.HO_INS_TYPE = #{hoInsType}    --種別が0,施設の場合 ：施設種別　　　--入力情報を受け取り判別
			OR  HCO_MST.HO_INS_TYPE = #{hoInsType}    --入力情報を受け取り判別：施設種別　
			)
		</if>
		<if test="docNo != null">
			AND HCP_MST.DOC_NO = #{docNo} --種別が1,医師の場合:医師固定コード(本来の数字は入力情報から取得する)
		</if>
		<if test="docKanj != null">
			AND(HCP_REQ.DOC_KANJ LIKE '%' || #{docKanj} || '%'--医師_申請管理:氏名（漢字）
			OR  HCP_MST.DOC_KANJI_SRCH LIKE '%' || #{docKanj} || '%'
			)
		</if>
		<if test="docType != null">
			AND(HCP_REQ.DOC_TYPE = #{docType} --種別が1,医師の場合:医師_申請管理：医師／薬剤師区分
			OR  HCP_MST.DOC_TYPE = #{docType}  --種別が1,医師の場合:医師_基本情報：医師／薬剤師区分
			)
		</if>
		<if test="jobForm != null">
			AND(HCP_REQ.JOB_FORM = #{jobForm}     --種別が1,医師の場合
			OR  HCP_KMU_REQ.JOB_FORM_BF = #{jobForm}
			OR  HCP_KMU_REQ.JOB_FORM_AF = #{jobForm})   --上記ともに本来は別途SQL?で値を取得したドロップダウンから数値を受け取り判定
		</if>

		<!-- 管理者項目 -->
		<if test='reqChl != null'>AND REQ_KNR.REQ_CHL IN #{reqChl}</if>

		<!-- 共通項目 -->
        <if test='reqSbt == "0"'>AND REQ_KNR.REQ_CHL IN ('1','2')
       	</if> --※検索条件．連携種別が0：手動の場合　かつ　申請チャネルに値が無い場合
		<if test='reqSbt == "1"'>AND REQ_KNR.REQ_CHL IN ('3','4')</if> --※検索条件．連携種別が1：ULT連携の場合　かつ　申請チャネルに値が無い場合



	    <if test="reqYmdhmsFrom != null">
	    AND SUBSTR(REQ_KNR.REQ_YMDHMS,1,8) &gt;= #{reqYmdhmsFrom} --中間の青いのについて、大なり小なり等がjspで判別されないため、エスケープ文字を使用
		</if>
		<if test="reqYmdhmsTo != null">
		AND SUBSTR(REQ_KNR.REQ_YMDHMS,1,8) &lt;= #{reqYmdhmsTo} --種別が0,施設の場合:年月日,a.REQ_YMDHMSは時間、分、秒...までだすのでYYYYMMDDまでを抜き出す
	    </if>
	    <if test="reqSts != null">
	    AND REQ_KNR.REQ_STS = #{reqSts}
	    </if>
	    <if test="reqId != null">
	    AND REQ_KNR.REQ_ID = #{reqId}
	    </if>
	    <if test="reqComment != null">
	    AND REQ_KNR.REQ_COMMENT LIKE '%' || #{reqComment} || '%'
	    </if>
	    <if test="aprComment != null">
	    AND REQ_KNR.APR_COMMENT LIKE '%' || #{aprComment} || '%'
	    </if>
	    <if test="reqType != null">
	    	<if test='reqType != "1X"'>
		    AND CODE_LB.VALUE1 = #{reqType}   --...ドロップダウンで選択するらしい?　　--入力情報を受け取り判別
		    </if>
		    <if test='reqType == "1X"'>
    		AND CODE_LB.VALUE1 IN('11','12','13')
		    </if>
    	</if>
    	<if test="jgiNo != null">
    	AND
		NOT(REQ_KNR.REQ_STS = '01'
		AND REQ_KNR.REQ_JGI_NO != #{jgiNo}　　--入力情報を受け取り判別
		)
		</if>
	    <if test='sbt == "0"'>
		AND NOT REQ_KNR.REQ_TYPE IN ('31','32','33','34')
		AND NOT REQ_KNR.REQ_TYPE IN ('41','42','43','44','51')
	    </if>
		<if test='sbt == "1"'>
		AND NOT REQ_KNR.REQ_TYPE IN ('01','02','03','04')
		AND NOT REQ_KNR.REQ_TYPE IN ('11','12','13','21')
	    </if>
		--ソートID NULL OR '0'
        <if test="inSortId == 0 or inSortId == null">ORDER BY REQ_KNR.REQ_ID ASC NULLS FIRST</if>
		--ソートID '1'
        <if test="inSortId == 1 ">ORDER BY REQ_KNR.REQ_ID DESC NULLS LAST</if>
		--ソートID '2'
        <if test="inSortId == 2 ">ORDER BY REQ_KNR.REQ_YMDHMS ASC NULLS FIRST</if>
        --ソートID '3'
        <if test="inSortId == 3 ">ORDER BY REQ_KNR.REQ_YMDHMS DESC NULLS LAST</if>
        --ソートID '4'
        <if test="inSortId == 4 ">ORDER BY REQ_KNR.REQ_CHL ASC NULLS FIRST</if>
        --ソートID '5'
        <if test="inSortId == 5 ">ORDER BY REQ_KNR.REQ_CHL DESC NULLS LAST</if>
        --ソートID '6'
        <if test="inSortId == 6 ">ORDER BY REQ_KNR.REQ_TYPE ASC NULLS FIRST</if>
        --ソートID '7'
        <if test="inSortId == 7 ">ORDER BY REQ_KNR.REQ_TYPE DESC NULLS LAST</if>
        --ソートID '8'
        <if test="inSortId == 8 ">ORDER BY REQ_KNR.REQ_STS ASC NULLS FIRST</if>
        --ソートID '9'
        <if test="inSortId == 9 ">ORDER BY REQ_KNR.REQ_STS DESC NULLS LAST</if>
        --ソートID '10'
        <if test="inSortId == 10 ">ORDER BY REQ_KNR.REQ_TYPE ASC NULLS FIRST</if>
        --ソートID '11'
        <if test="inSortId == 11 ">ORDER BY REQ_KNR.REQ_TYPE DESC NULLS LAST</if>
        --ソートID '12'
        <if test="inSortId == 12 ">ORDER BY REQ_KNR.REQ_JGI_NAME ASC NULLS FIRST</if>
        --ソートID '13'
        <if test="inSortId == 13 ">ORDER BY REQ_KNR.REQ_JGI_NAME DESC NULLS LAST</if>
    	OFFSET #{inOffset} ROWS FETCH FIRST #{inLimit} ROWS ONLY
	</select>
  <select id="countReqKnr" parameterType="jp.co.takeda.rdm.entity.SRdmReqListEntity" resultMap="selectCntReqListResultMap">
	  SELECT COUNT(*) CNT_REQ
 	  FROM(
		WITH HCP_KMS_MAX AS(--■サブクエリ（医師勤務先）
		    SELECT MAX(INS_NO) MAX_INS_NO,
		           DOC_NO
		      FROM ORAUSR01.M_RDM_HCP_WORK
		      GROUP BY DOC_NO
		)
		, HCP_INS AS (--■サブクエリ（医師勤務）
		    SELECT  HCP_REQ.REQ_ID
		           ,CASE
		                 WHEN REQ_KNR.REQ_TYPE IN ('31','34') THEN HCP_REQ.INS_NO_SK
		                 WHEN HCP_KMS_MAX.MAX_INS_NO IS NULL THEN '000000000'
		                 ELSE HCP_KMS_MAX.MAX_INS_NO
		            END HCP_INS_NO
		      FROM  ORAUSR01.T_RDM_HCP_REQ HCP_REQ
		           LEFT JOIN
		            HCP_KMS_MAX
		           ON (
		                 HCP_REQ.DOC_NO = HCP_KMS_MAX.DOC_NO
		              )
		           LEFT JOIN
		            ORAUSR01.T_RDM_REQ_KNR REQ_KNR
		           ON (
		                 REQ_KNR.REQ_ID = HCP_REQ.REQ_ID
		              )
		)
		,PREF_MST AS(  --■サブクエリ（都道府県）
    SELECT DISTINCT
          ADDR_CODE_PREF
    FROM  ORAUSR01.S_RDM_JKR_SOS_ADDR
    )

	  SELECT
		  	REQ_KNR.REQ_ID
		   ,REQ_KNR.REQ_YMDHMS
		   ,REQ_KNR.REQ_CHL
		   ,REQ_KNR.REQ_TYPE
		   ,REQ_KNR.REQ_STS,

		    --(検索処理:施設か医師かの判定:医師)
		    --HCO_REQ.INS_NO,HCO_REQ.INS_FORMAL_NAME,

		    CASE
			        WHEN REQ_KNR.REQ_TYPE IN ('01') THEN HCO_REQ.INS_NO
			        WHEN REQ_KNR.REQ_TYPE IN ('11','12','13','21','02','03','04')  THEN HCO_MST.INS_NO
			END AS INS_NO
			,CASE
			        WHEN REQ_KNR.REQ_TYPE IN ('01') THEN HCO_REQ.INS_FORMAL_NAME
			        WHEN REQ_KNR.REQ_TYPE IN ('11','12','13','21','02','03','04')   THEN HCO_MST.INS_FORMAL_NAME
			END AS INS_FORMAL_NAME

		    ,CASE
			        WHEN REQ_KNR.REQ_TYPE IN ('31') THEN HCP_REQ.DOC_NO
			        WHEN REQ_KNR.REQ_TYPE IN ('32','33','34')  THEN HCP_MST.DOC_NO
			        WHEN REQ_KNR.REQ_TYPE IN ('41','42','43','44','51')  THEN HCO_MST.INS_NO || '／' || HCP_MST.DOC_NO
			END AS DOC_NO
			,CASE
			        WHEN REQ_KNR.REQ_TYPE IN ('31') THEN HCP_REQ.DOC_KANJ
			        WHEN REQ_KNR.REQ_TYPE IN ('32','33','34')  THEN HCP_MST.DOC_KANJ
			        WHEN REQ_KNR.REQ_TYPE IN ('41','42','43','44','51')  THEN HCO_MST.INS_FORMAL_NAME || '／' || HCP_MST.DOC_KANJ
			END AS DOC_KANJ
		    ,REQ_KNR.REQ_JGI_NAME
		    ,REQ_KNR.REQ_SHZ
		    ,REQ_KNR.REQ_COMMENT
		    ,REQ_KNR.APR_YMDHMS
		    ,REQ_KNR.APR_SHA_ID
		    ,REQ_KNR.APR_MEMO
		    ,REQ_KNR.APR_COMMENT
		<if test='mrAdminFlg == "1"'>
		   ,REQ_KNR.SHN_FLG
		   ,REQ_KNR.SHN_YMDHMS
		   ,REQ_KNR.SHN_SHA_ID
		    --,REQ_KNR.FB_REQ_FLG
		    ,CODE_REQ_FLG.VALUE1_KANJ FB_REQ_FLG
		    ,REQ_KNR.FB_ANS_ID
		    --,REQ_KNR.FB_PRC_TYPE
			,CODE_PRC_TYPE.VALUE1_KANJ FB_PRC_TYPE
		</if>
	  FROM  ORAUSR01.T_RDM_REQ_KNR REQ_KNR --申請管理
			left join ORAUSR01.T_RDM_HCO_REQ HCO_REQ --施設_申請管理　
			on HCO_REQ.REQ_ID=REQ_KNR.REQ_ID
			left join ORAUSR01.T_RDM_HCO_NXT_REQ HCO_NXT_REQ --施設_来期用_申請管理
			on HCO_NXT_REQ.REQ_ID=REQ_KNR.REQ_ID
			left join ORAUSR01.T_RDM_HCO_LNK_REQ HCO_LNK_REQ --武田紐親子_来期用_申請管理
			on HCO_LNK_REQ.REQ_ID=REQ_KNR.REQ_ID
			left join ORAUSR01.T_RDM_HCO_LNK_NXT_REQ HCO_LNK_NXT_REQ --領域品目グループ別親子_申請管理
			on HCO_LNK_NXT_REQ.REQ_ID=REQ_KNR.REQ_ID
			left join ORAUSR01.T_RDM_HCP_REQ HCP_REQ --医師_申請管理
			on HCP_REQ.REQ_ID=REQ_KNR.REQ_ID
			left join ORAUSR01.T_RDM_HCP_KMU_REQ HCP_KMU_REQ --勤務先_申請管理
			on HCP_KMU_REQ.REQ_ID=REQ_KNR.REQ_ID
            LEFT JOIN HCP_INS  --■サブクエリ（医師勤務）
		    ON HCP_INS.REQ_ID=REQ_KNR.REQ_ID
			LEFT JOIN
	        ORAUSR01.M_RDM_HCO_MST HCO_MST -- 施設_基本情報
	        --ON HCP_INS.HCP_INS_NO=HCO_MST.INS_NO
            --OR HCO_REQ.INS_NO=HCO_MST.INS_NO
			--ON HCO_MST.INS_NO=nvl2(REQ_KNR.INS_NO,REQ_KNR.INS_NO,nvl2(HCO_REQ.INS_NO,HCO_REQ.INS_NO,nvl2(HCO_REQ.INS_NO,HCO_REQ.INS_NO,nvl2(HCO_NXT_REQ.INS_NO,HCO_NXT_REQ.INS_NO,nvl2(HCO_LNK_REQ.INS_NO,HCO_LNK_REQ.INS_NO,nvl2(HCO_LNK_NXT_REQ.INS_NO,HCO_LNK_NXT_REQ.INS_NO,nvl2(HCP_REQ.INS_NO_SK,HCP_REQ.INS_NO_SK,nvl2(HCP_KMU_REQ.INS_NO_SK,HCP_KMU_REQ.INS_NO_SK,HCP_KMU_REQ.INS_NO_MT))))))))
	      ON  HCP_INS.HCP_INS_NO=HCO_MST.INS_NO
              OR HCO_REQ.INS_NO=HCO_MST.INS_NO
              OR HCO_NXT_REQ.INS_NO=HCO_MST.INS_NO
              OR HCO_LNK_NXT_REQ.INS_NO=HCO_MST.INS_NO
              OR HCO_LNK_REQ.INS_NO=HCO_MST.INS_NO
            left join PREF_MST PREF_MST_A
            on PREF_MST_A.ADDR_CODE_PREF=HCO_REQ.ADDR_CODE_PREF
            left join PREF_MST PREF_MST_B
            on PREF_MST_B.ADDR_CODE_PREF=HCO_MST.ADDR_CODE_PREF
			left join ORAUSR01.M_RDM_HCP_MST HCP_MST --医師_基本情報
			on HCP_MST.DOC_NO=nvl2(REQ_KNR.DOC_NO,REQ_KNR.DOC_NO,nvl2(REQ_KNR.DOC_NO,REQ_KNR.DOC_NO,nvl2(HCP_REQ.DOC_NO,HCP_REQ.DOC_NO,HCP_KMU_REQ.DOC_NO)))
			left join  ORAUSR01.M_RDM_CODE_MST CODE_LB --コード情報 申請区分_LB
			on  CODE_LB.CODE_NAME = 'REQ_KBN_LB'
			AND CODE_LB.DEL_FLG = '0'
      		AND CODE_LB.VALUE1 = REQ_KNR.REQ_TYPE
			left join  ORAUSR01.M_RDM_CODE_MST CODE_LBV --コード情報 申請区分_LBV
			on  CODE_LBV.CODE_NAME = 'REQ_KBN_LBV'
			AND CODE_LBV.DEL_FLG = '0'
			AND CODE_LBV.VALUE2 = CODE_LB.VALUE1
			AND CODE_LBV.VALUE3 = REQ_KNR.REQ_TYPE
			<if test='mrAdminFlg == "1"'>
		    left join  ORAUSR01.M_RDM_CODE_MST CODE_REQ_FLG --コード情報FB申請要否
			ON CODE_REQ_FLG.VALUE1 = REQ_KNR.FB_REQ_FLG
		    AND CODE_REQ_FLG.CODE_NAME ='FB_REQ_FLG'
		    left join  ORAUSR01.M_RDM_CODE_MST CODE_PRC_TYPE --コード情報FB処理区分
			ON  CODE_PRC_TYPE.VALUE1 = REQ_KNR.FB_PRC_TYPE
		    AND CODE_PRC_TYPE.CODE_NAME ='FB_PRC_TYPE'
		    </if>
	WHERE
		1=1
		<if test="insNo != null">
	   		 AND HCO_MST.INS_NO = #{insNo}
	    </if>
	    <if test="reqType != null">
			<if test='reqType != "1X"'>
			    AND REQ_KNR.REQ_TYPE = #{reqType} --種別が0,施設の場合:申請区分　　--入力情報を受け取り判別
		    </if>
		    <if test='reqType == "1X"'>
			    AND REQ_KNR.REQ_TYPE IN ( '11','12','13')
			</if>
	    </if>
	    <if test="aDdrCodePref != null">
	    	<if test="reqType != null">
			    <if test='aDdrCodePref != "99"'>
				   <if test='reqType == "01"'><!-- &amp;で&になる -->
					    AND HCO_REQ.ADDR_CODE_PREF = #{aDdrCodePref}　--入力情報を受け取り判別 --//施設申請管理
				   </if>
				   <if test='reqType == "31"'><!-- &amp;で&になる -->
					    AND HCO_MST.ADDR_CODE_PREF = #{aDdrCodePref}
				   </if>
				   <if test='reqType != "01" &amp;&amp; reqType != "31"'>
						AND  HCO_MST.ADDR_CODE_PREF = #{aDdrCodePref}　　--入力情報を受け取り判別	  --//施設マスタ
			       </if>
			    </if>
			    <if test='aDdrCodePref == "99"'>
				    <if test='reqType == "01"'>
					    AND PREF_MST_A.ADDR_CODE_PREF IS NULL　--入力情報を受け取り判別 --//施設申請管理
				    </if>
				    <if test='reqType == "31" or reqType == "34"'>
					    AND PREF_MST_B.ADDR_CODE_PREF IS NULL　--入力情報を受け取り判別 --//施設申請管理
				    </if>
				    <if test='reqType == "1X"'>
				    	<!-- 旧ver
				    	AND( HCO_MST.ADDR_CODE_PREF IS NULL　　
						OR   HCO_MST.ADDR_CODE_PREF = 'Z'
						OR   HCO_MST.ADDR_CODE_PREF = '00'
						OR   HCO_MST.ADDR_CODE_PREF = '51'
		                )
				    	 -->
						AND( PREF_MST_A.ADDR_CODE_PREF IS NULL　　--入力情報を受け取り判別	  --//施設マスタ
						AND   PREF_MST_B.ADDR_CODE_PREF IS NULL
		                )
				    </if>
				    <if test='reqType == "21"'>
				    	<!-- 旧ver
				    	AND( HCO_MST.ADDR_CODE_PREF IS NULL　　
						OR   HCO_MST.ADDR_CODE_PREF = 'Z'
						OR   HCO_MST.ADDR_CODE_PREF = '00'
						OR   HCO_MST.ADDR_CODE_PREF = '51'
		                )
				    	 -->
						AND( PREF_MST_A.ADDR_CODE_PREF IS NULL　　--入力情報を受け取り判別	  --//施設マスタ
						AND   PREF_MST_B.ADDR_CODE_PREF IS NULL
		                )
				    </if>
				    <if test='reqType != "01" &amp;&amp; reqType != "31" &amp;&amp; reqType != "1X" &amp;&amp; reqType != "21"'>
						AND PREF_MST_B.ADDR_CODE_PREF IS NULL　　--入力情報を受け取り判別	  --//施設マスタ
				    </if>
				</if>
			</if>
			<if test="reqType == null">
			   	<if test='aDdrCodePref != "99"'>
					    AND(HCO_REQ.ADDR_CODE_PREF = #{aDdrCodePref}　--入力情報を受け取り判別 --//01 24しかなかったので24で行きます
						OR  HCO_MST.ADDR_CODE_PREF = #{aDdrCodePref}　　--入力情報を受け取り判別
					    )
			    </if>
			    <if test='aDdrCodePref == "99"'>
				    	<!-- 旧ver
				    	AND( HCO_MST.ADDR_CODE_PREF IS NULL　　
						OR   HCO_MST.ADDR_CODE_PREF = 'Z'
						OR   HCO_MST.ADDR_CODE_PREF = '00'
						OR   HCO_MST.ADDR_CODE_PREF = '51'
		                )
				    	 -->
						AND( PREF_MST_A.ADDR_CODE_PREF IS NULL　　--入力情報を受け取り判別	  --//施設マスタ
						AND   PREF_MST_B.ADDR_CODE_PREF IS NULL
		                )
			    </if>
			</if>
	    </if>
	    <!-- MRのみ　申請者従業員番号 -->
	    <if test="jgiNo != null">
	    	<if test='mrAdminFlg == "0"'>
				AND REQ_KNR.REQ_JGI_NO = #{jgiNo}
			</if>
	    </if><!-- MR -->
	    <!-- 管理者のみ -->
	    <if test='mrAdminFlg == "1"'>
	    <if test="brCode != null">
	    	AND REQ_KNR.REQ_BR_CODE = #{brCode} --管理者権限の場合　医薬支店C(本来の数字は入力される？)	    </if>
	    <if test="distCode != null">
			AND REQ_KNR.REQ_DIST_CODE = #{distCode} --管理者権限の場合　医薬営業所C(本来の数字は入力される？)		</if>
	    <if test="reqJgiName != null">
	    	AND REQ_KNR.REQ_JGI_NAME LIKE  '%' || #{reqJgiName} || '%'
	    </if>
	   	<!-- 管理者 -->
		</if>
	    <if test=" insKanjiSrch != null">
		    AND(HCO_REQ.INS_ABBR_NAME LIKE  '%' || #{insKanjiSrch} || '%'
			OR  HCO_REQ.INS_FORMAL_NAME LIKE'%' || #{insKanjiSrch} || '%'
			OR  HCO_REQ.INS_CONT_NAME LIKE  '%' || #{insKanjiSrch} || '%'
			OR  HCO_MST.INS_KANJ_SRCH LIKE  '%' || #{insKanjiSrch} || '%'
		    )
	    </if>
	    <if test="insNo != null">
	    AND HCO_MST.INS_NO = #{insNo}
	    AND
			(  HCO_REQ.INS_NO = #{insNo} --種別が0,施設の場合:施設固定コード(本来の数字は入力情報から取得する)
			OR HCO_NXT_REQ.INS_NO = #{insNo}
			OR HCO_LNK_REQ.INS_NO = #{insNo}
			OR HCO_LNK_NXT_REQ.INS_NO = #{insNo}
			OR HCP_REQ.INS_NO_SK = #{insNo}
			OR HCP_KMU_REQ.INS_NO_SK = #{insNo}
			OR HCP_KMU_REQ.INS_NO_MT = #{insNo}
			)
		</if>

		<if test="insClass != null">
			AND(HCO_REQ.INS_CLASS = #{insClass} --種別が0,施設の場合:施設_申請管理：施設分類　　--入力情報を受け取り判別
			OR  HCO_MST.INS_CLASS = #{insClass}　--種別が0,施設の場合:施設_基本情報：施設分類　　--入力情報を受け取り判別
			)
		</if>
		<if test="insSbt != null">
			AND(HCO_REQ.INS_SBT = #{insSbt}    --種別が0,施設の場合 ：施設種別　　　--入力情報を受け取り判別
			OR  HCO_MST.INS_SBT = #{insSbt}    --入力情報を受け取り判別：施設種別　
			)
		</if>
		<if test="hoInsType != null">
			AND(HCO_REQ.HO_INS_TYPE = #{hoInsType}    --種別が0,施設の場合 ：施設種別　　　--入力情報を受け取り判別
			OR  HCO_MST.HO_INS_TYPE = #{hoInsType}    --入力情報を受け取り判別：施設種別　
			)
		</if>
		<if test="docNo != null">
			AND HCP_MST.DOC_NO = #{docNo} --種別が1,医師の場合:医師固定コード(本来の数字は入力情報から取得する)
		</if>
		<if test="docKanj != null">
			AND(HCP_REQ.DOC_KANJ LIKE '%' || #{docKanj} || '%'--医師_申請管理:氏名（漢字）
			OR  HCP_MST.DOC_KANJI_SRCH LIKE '%' || #{docKanj} || '%'
			)
		</if>
		<if test="docType != null">
			AND(HCP_REQ.DOC_TYPE = #{docType} --種別が1,医師の場合:医師_申請管理：医師／薬剤師区分
			OR  HCP_MST.DOC_TYPE = #{docType}  --種別が1,医師の場合:医師_基本情報：医師／薬剤師区分
			)
		</if>
		<if test="jobForm != null">
			AND(HCP_REQ.JOB_FORM = #{jobForm}     --種別が1,医師の場合
			OR  HCP_KMU_REQ.JOB_FORM_BF = #{jobForm}
			OR  HCP_KMU_REQ.JOB_FORM_AF = #{jobForm})   --上記ともに本来は別途SQL?で値を取得したドロップダウンから数値を受け取り判定
		</if>

		<!-- 管理者項目 -->
		<if test='reqChl != null'>AND REQ_KNR.REQ_CHL IN #{reqChl}</if>

		<!-- 共通項目 -->
        <if test='reqSbt == "0"'>AND REQ_KNR.REQ_CHL IN ('1','2')
       	</if> --※検索条件．連携種別が0：手動の場合　かつ　申請チャネルに値が無い場合
		<if test='reqSbt == "1"'>AND REQ_KNR.REQ_CHL IN ('3','4')</if> --※検索条件．連携種別が1：ULT連携の場合　かつ　申請チャネルに値が無い場合



	    <if test="reqYmdhmsFrom != null">
	    AND SUBSTR(REQ_KNR.REQ_YMDHMS,1,8) &gt;= #{reqYmdhmsFrom} --中間の青いのについて、大なり小なり等がjspで判別されないため、エスケープ文字を使用
		</if>
		<if test="reqYmdhmsTo != null">
		AND SUBSTR(REQ_KNR.REQ_YMDHMS,1,8) &lt;= #{reqYmdhmsTo} --種別が0,施設の場合:年月日,a.REQ_YMDHMSは時間、分、秒...までだすのでYYYYMMDDまでを抜き出す
	    </if>
	    <if test="reqSts != null">
	    AND REQ_KNR.REQ_STS = #{reqSts}
	    </if>
	    <if test="reqId != null">
	    AND REQ_KNR.REQ_ID = #{reqId}
	    </if>
	    <if test="reqComment != null">
	    AND REQ_KNR.REQ_COMMENT LIKE '%' || #{reqComment} || '%'
	    </if>
	    <if test="aprComment != null">
	    AND REQ_KNR.APR_COMMENT LIKE '%' || #{aprComment} || '%'
	    </if>
	    <if test="reqType != null">
	    	<if test='reqType != "1X"'>
		    AND CODE_LB.VALUE1 = #{reqType}   --...ドロップダウンで選択するらしい?　　--入力情報を受け取り判別
		    </if>
		    <if test='reqType == "1X"'>
    		AND CODE_LB.VALUE1 IN('11','12','13')
		    </if>
    	</if>
    	<if test="jgiNo != null">
    	AND
		NOT(REQ_KNR.REQ_STS = '01'
		AND REQ_KNR.REQ_JGI_NO != #{jgiNo}　　--入力情報を受け取り判別
		)
		</if>
	    <if test='sbt == "0"'>
		AND NOT REQ_KNR.REQ_TYPE IN ('31','32','33','34')
		AND NOT REQ_KNR.REQ_TYPE IN ('41','42','43','44','51')
	    </if>
		<if test='sbt == "1"'>
		AND NOT REQ_KNR.REQ_TYPE IN ('01','02','03','04')
		AND NOT REQ_KNR.REQ_TYPE IN ('11','12','13','21')
		</if>
		)SELECT_REQ
	</select>
</mapper>
